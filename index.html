<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydrun</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-extra-markers/dist/css/leaflet.extra-markers.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- CSS STYLES START --- */
        body {
            font-family: "Segoe UI", sans-serif;
            background: #f2f2f2;
            margin: 0;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #0077ff;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        h2 {
            color: #333;
            font-size: 1.8em;
            margin-top: 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        h3 {
            color: #555;
            font-size: 1.4em;
            margin-top: 25px;
            margin-bottom: 10px;
        }

        h4 {
            color: #666;
            font-size: 1.2em;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid #e0e0e0;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"] {
            width: calc(100% - 22px); /* Account for padding and border */
            padding: 11px;
            margin: 8px 0 15px 0;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus {
            border-color: #0077ff;
            outline: none;
        }

        button {
            padding: 12px 20px;
            background: #0077ff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
            width: 100%; /* Full width for consistency */
            margin-top: 10px; /* Space above buttons */
        }

        button:hover {
            background: #0055cc;
        }

        button:active {
            background: #0044bb;
        }

        /* Style for the map container */
        #map {
            width: 100%;
            height: 350px;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .hidden {
            display: none;
        }

        p {
            margin-top: 15px;
            font-size: 1.1em;
            color: #444;
        }

        ul, ol {
            list-style-type: none; /* Remove default list bullets */
            padding: 0;
            margin: 15px 0;
        }

        ul li, ol li {
            background: #f9f9f9;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 6px;
            border: 1px solid #eee;
            display: flex;
            justify-content: space-between; /* Space out content if needed */
            align-items: center;
        }

        ol li {
            counter-increment: leaderboard-counter;
            padding-left: 40px; /* Space for counter */
            position: relative;
        }

        ol li::before {
            content: counter(leaderboard-counter) ".";
            position: absolute;
            left: 15px;
            font-weight: bold;
            color: #0077ff;
        }

        .highlight-user {
            background: #e6f2ff; /* Light blue background for current user */
            border-color: #0077ff;
            font-weight: bold;
        }

        /* Moved logout button styling to a class, as it's no longer inside #userDisplay */
        .logout-button {
            display: inline-block;
            width: auto;
            margin-left: 0; /* Adjust margin for its new location */
            padding: 8px 15px;
            background: #dc3545; /* Red for logout */
        }

        .logout-button:hover {
            background: #c82333;
        }

        /* Message for user feedback */
        .feedback-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .feedback-message.show {
            opacity: 1;
        }
        .feedback-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        /* Camera specific styles */
        #cameraStream {
            width: 100%;
            height: auto;
            background-color: #000;
            border-radius: 8px;
            display: block; /* Ensure it takes full width */
            margin-bottom: 15px;
        }
        #captureCanvas {
            display: block; /* Hidden by default, shown after capture */
            margin-top: 15px;
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .camera-controls button {
            margin-top: 10px;
        }

        /* New styles for section toggling */
        .tab-buttons {
            display: flex;
            justify-content: center;
            gap: 10px; /* Space between buttons */
            margin-bottom: 25px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        }
        .tab-buttons button {
            flex: 1; /* Make buttons take equal width */
            min-width: 120px; /* Ensure buttons don't get too small */
            margin-top: 0; /* Override default button margin */
        }
        .tab-buttons button.active {
            background: #0055cc; /* Darker blue for active tab */
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); /* Inset shadow for active state */
        }

        /* Styles for AI Advice sections */
        .ai-advice {
            background-color: #e8f5e9; /* Light green background */
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            color: #2e7d32; /* Dark green text */
        }
        .ai-advice h4 {
            color: #1b5e20; /* Even darker green for heading */
            margin-top: 0;
            margin-bottom: 10px;
        }
        .ai-advice ul {
            list-style-type: disc; /* Use regular bullets for lists */
            margin-left: 20px;
            padding-left: 0;
        }
        .ai-advice ul li {
            background: none;
            border: none;
            padding: 5px 0;
            margin-bottom: 5px;
            color: #388e3c;
        }

        /* Premium Pass Styles */
        .premium-section {
            background-color: #fff3e0; /* Light orange background */
            border: 1px solid #ffe0b2;
            color: #e65100; /* Darker orange text */
        }
        .premium-section h2 {
            color: #ff6f00; /* Orange heading */
            border-bottom-color: #ffcc80;
        }
        .premium-section h3 {
            color: #e65100;
        }
        .premium-content {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #ffcc80;
        }
        .premium-content ul {
            list-style-type: circle; /* Different bullet for premium lists */
            margin-left: 20px;
            padding-left: 0;
        }
        .premium-content ul li {
            background: none;
            border: none;
            padding: 5px 0;
            margin-bottom: 5px;
            color: #e65100;
        }
        .premium-content p {
            color: #e65100;
            font-style: italic;
        }

        /* Profile Section specific styles */
        #profileSection p {
            margin-bottom: 10px;
        }
        #profileSection .form-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        #profileSection .form-group label {
            margin-bottom: 0;
            font-weight: normal;
            flex-grow: 1; /* Allow label to take available space */
        }
        #profileSection .switch {
            position: relative;
            display: inline-block;
            width: 45px;
            height: 25px;
        }

        #profileSection .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        #profileSection .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 25px; /* Rounded slider */
        }

        #profileSection .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 3.5px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%; /* Rounded handle */
        }

        #profileSection input:checked + .slider {
            background-color: #0077ff;
        }

        #profileSection input:focus + .slider {
            box-shadow: 0 0 1px #0077ff;
        }

        #profileSection input:checked + .slider:before {
            -webkit-transform: translateX(20px);
            -ms-transform: translateX(20px);
            transform: translateX(20px);
        }
        /* --- CSS STYLES END --- */
    </style>
</head>
<body>
    <div id="loginContainer" class="card">
        <h2>Login to Hydrun</h2>
        <input type="email" id="userEmail" placeholder="Enter your email" />
        <input type="text" id="usernameInput" placeholder="Choose a username" />
        <button onclick="login()">Login</button>
    </div>

    <div id="appContainer" class="hidden">
        <header>
            <h1>🏃💧 Hydrun</h1>
            <p>Welcome, <span id="userDisplay"></span>!</p>
        </header>

        <div class="tab-buttons">
            <button id="showWaterBtn" onclick="showSection('waterSection')">💧 Water Tracker</button>
            <button id="showRunBtn" onclick="showSection('runSection')">🏃 Run Tracker</button>
            <button id="showProfileBtn" onclick="showSection('profileSection')">👤 Profile</button>
            <button id="showPremiumBtn" onclick="showSection('premiumSection')">✨ Premium Pass</button>
        </div>

        <section id="waterSection" class="card">
            <h2>💧 Water Tracker</h2>
            <label>Daily Goal (L): <input type="number" id="waterDailyGoal" value="2" min="0.1" step="0.1" /></label>
            <label>Monthly Goal (L): <input type="number" id="waterMonthlyGoal" value="60" min="1" step="1" /></label>
            <label>Add Water (L): <input type="number" id="waterInput" min="0.1" step="0.1" /></label>
            <button onclick="logWater()">Add Water</button>
            <p>Daily: <span id="waterDailyStatus">Drank: 0.00 L (0.0%)</span></p>
            <p>Monthly: <span id="waterMonthlyStatus">Drank: 0.00 L (0.0%)</span></p>
            <div id="waterFeedback" class="feedback-message hidden"></div>

            <hr>
            <h3>📸 Camera for Water Estimation</h3>
            <p>Use your camera to capture an image of your water container. Based on the picture, **you'll need to manually estimate** the water added or remaining and log it above.</p>
            <button onclick="startCamera()">Start Camera</button>
            <button onclick="captureImage()">Capture Image</button>
            <button onclick="stopCamera()">Stop Camera</button>
            <video id="cameraStream" autoplay playsinline class="hidden"></video>
            <canvas id="captureCanvas" class="hidden"></canvas>
            <div id="cameraFeedback" class="feedback-message hidden"></div>

            <hr>
            <div class="ai-advice">
                <h4>🧠 AI Water Advice</h4>
                <ul id="waterAdviceList"></ul>
            </div>
        </section>

        <section id="runSection" class="card hidden">
            <h2>📍 Run Tracker</h2>
            <label>Daily Goal (km): <input type="number" id="runDailyGoal" value="5" min="0.1" step="0.1" /></label>
            <label>Monthly Goal (km): <input type="number" id="runMonthlyGoal" value="100" min="1" step="1" /></label>
            <button onclick="startRun()">Start Run</button>
            <button onclick="stopRun()">Stop Run</button>
            <button onclick="markMyLocation()">Mark My Location</button>
            <p id="runStatus">Not running</p>
            <p id="distanceDisplay">Current Run: 0.00 km</p>
            <p>Daily: <span id="runDailyStatus">Ran: 0.00 km (0.0%)</span></p>
            <p>Monthly: <span id="runMonthlyStatus">Ran: 0.00 km (0.0%)</span></p>
            <p>Total Lifetime Run: <span id="totalRunDisplay">0.00 km</span></p>
            <div id="map"></div>
            <div id="runFeedback" class="feedback-message hidden"></div>

            <hr>
            <div class="ai-advice">
                <h4>🧠 AI Running Advice</h4>
                <ul id="runAdviceList"></ul>
            </div>

            <hr>
            <h3>👫 Friends & Leaderboard</h3>
            <label>Add friend by username: <input type="text" id="friendName" placeholder="Friend's username" /></label>
            <button onclick="addFriend()">Add Friend</button>
            <div id="friendFeedback" class="feedback-message hidden"></div>

            <h4>Your Friends</h4>
            <ul id="friendList"></ul>

            <h4>🏆 Leaderboard</h4>
            <ol id="leaderboardList"></ol>
        </section>

        <section id="profileSection" class="card hidden">
            <h2>👤 Your Profile</h2>
            <p>Username: <strong id="profileUsernameDisplay"></strong></p>
            <p>Email: <strong id="profileEmailDisplay"></strong></p>

            <hr>

            <h3>⏰ Reminders</h3>
            <p>Get helpful nudges to stay on track!</p>

            <div class="form-group">
                <label for="waterRemindersToggle">Water Reminders (every 2 hours)</label>
                <label class="switch">
                    <input type="checkbox" id="waterRemindersToggle" onchange="toggleWaterReminders()">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="form-group">
                <label for="runRemindersToggle">Run Reminders (daily)</label>
                <label class="switch">
                    <input type="checkbox" id="runRemindersToggle" onchange="toggleRunReminders()">
                    <span class="slider"></span>
                </label>
            </div>
            <div id="reminderFeedback" class="feedback-message hidden"></div>

            <hr>

            <button onclick="logout()" class="logout-button">Logout</button>
        </section>


        <section id="premiumSection" class="card premium-section hidden">
            <h2>✨ Hydrun Premium Pass</h2>
            <div id="premiumContent">
                <p>Unlock advanced features for just <strong style="color: #ff6f00;">$10/month</strong>!</p>
                <button onclick="activatePremium()">Get Premium Pass!</button>
                <div id="premiumFeedback" class="feedback-message hidden"></div>
            </div>

            <div id="premiumFeatures" class="premium-content hidden">
                <h3>Personalized Training Routine</h3>
                <ul>
                    <li>**Best Running Times:**
                        <ul>
                            <li>For **endurance and fat burning**, consider early morning runs (6 AM - 8 AM) before breakfast to tap into fat reserves.</li>
                            <li>For **performance and speed**, late afternoon (4 PM - 6 PM) often aligns with peak body temperature and muscle efficiency.</li>
                            <li>**Listen to your body** and consider your sleep cycle. Consistency is key!</li>
                        </ul>
                    </li>
                    <li>**Suggested Running Routes:**
                        <ul>
                            <li>**Interval Training (2-3 km loop):** Find a flat path or track. Alternate 1 min fast sprint, 2 min brisk walk/jog for 20-30 mins.</li>
                            <li>**Long Slow Distance (5-10 km loop):** Choose a scenic route with varied terrain. Maintain a conversational pace, focusing on consistent breathing.</li>
                            <li>**Hill Repeats (0.5-1 km incline):** Find a moderate hill. Sprint up (or strong jog), walk down to recover. Repeat 5-8 times.</li>
                            <li>**Explore new areas** using your map! Look for parks, riverside paths, or quiet residential streets.</li>
                        </ul>
                    </li>
                </ul>

                <h3>Make Drinking Water Less Boring</h3>
                <ul>
                    <li>**Infused Water:** Add slices of fresh fruit (lemon, lime, orange, berries), cucumber, mint leaves, or ginger to your water. Let it steep for a few hours in the fridge.</li>
                    <li>**Sparkling Water Mixer:** Mix plain sparkling water with a splash of fruit juice, a few berries, or a slice of citrus for a bubbly treat without excess sugar.</li>
                    <li>**Herbal Tea (Iced or Hot):** Brew your favorite caffeine-free herbal teas (peppermint, chamomile, hibiscus) and enjoy them chilled or warm. They count towards hydration!</li>
                    <li>**Water Challenge:** Set hourly alarms or use an app to remind you to drink. Challenge yourself to finish a certain amount by midday.</li>
                    <li>**Flavor Droplets:** Natural flavor drops (available online or in health stores) can add a hint of taste without calories or artificial sweeteners.</li>
                </ul>
            </div>
        </section>

    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-extra-markers/dist/js/leaflet.extra-markers.min.js"></script>
    <script>
        /* --- JAVASCRIPT LOGIC START --- */
        // --- Centralized App State ---
        let appState = {
            user: {
                username: "",
                email: "",
                waterDrankDaily: 0,
                waterDailyGoal: 2,
                waterDrankMonthly: 0,
                waterMonthlyGoal: 60,
                runDistanceDaily: 0,
                runDailyGoal: 5,
                runDistanceMonthly: 0,
                runMonthlyGoal: 100,
                totalRunDistance: 0,
                friends: [],
                isPremium: false,
                lastDailyReset: new Date().toDateString(),
                lastMonthlyReset: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toDateString(),
                waterRemindersEnabled: false, // NEW: Reminder setting
                runRemindersEnabled: false,   // NEW: Reminder setting
                lastWaterReminderSent: null,  // To prevent rapid-fire reminders
                lastRunReminderSent: null     // To prevent rapid-fire reminders
            },
            currentRun: {
                isActive: false,
                segmentDistance: 0,
                routeCoordinates: [], // Stores [latitude, longitude] pairs for Leaflet
                watchId: null,
                map: null,      // Will now hold Leaflet map object
                marker: null,   // Will now hold Leaflet marker object (for run tracking)
                polyline: null  // To draw the path on the map
            },
            otherRunners: [
                { name: "Alice", totalRunDistance: 7.2 },
                { name: "Bob", totalRunDistance: 5.5 },
                { name: "Charlie", totalRunDistance: 6.8 },
                { name: "Diana", totalRunDistance: 8.1 },
                { name: "Eve", totalRunDistance: 12.3 },
                { name: "Frank", totalRunDistance: 4.0 }
            ],
            cameraStream: null,
            myLocationMarker: null,
            // Store reminder interval IDs globally to manage them
            waterReminderIntervalId: null,
            runReminderIntervalId: null
        };

        // --- Define your arrays of tips (for dynamic display) ---
        const waterTips = [
            "Stay consistent: Sip water throughout the day, don't wait until you're thirsty!",
            "Hydrate before meals: Drinking a glass of water before eating can aid digestion and help manage appetite.",
            "Factor in activity: Increase your water intake when exercising or in hot weather. Aim for 0.5-1.0L per hour of moderate to intense activity.",
            "Monitor urine color: Pale yellow usually indicates good hydration. Darker urine suggests you need more water.",
            "Add flavor naturally: If plain water is boring, try adding slices of lemon, cucumber, or berries.",
            "Keep a water bottle handy: Having water within reach makes it easier to remember to drink regularly.",
            "Set reminders: Use alarms or apps to remind yourself to drink water throughout the day.",
            "Drink an extra glass for every alcoholic drink: Alcohol is dehydrating, so compensate accordingly."
        ];

        const runTips = [
            "Pre-run hydration: Drink 500ml of water 1-2 hours before your run.",
            "During long runs: For runs over 60 minutes, consider electrolytes or sports drinks. Aim for 150-250ml every 15-20 minutes.",
            "Post-run recovery: Replenish fluids and electrolytes immediately after your run. Weigh yourself before and after a run to estimate fluid loss (1kg lost = 1 liter to replace).",
            "Warm-up is key: Always start with a dynamic warm-up to prepare your muscles and prevent injury.",
            "Listen to your body: Don't push through sharp pain. Rest and recovery are just as important as training.",
            "Gradual progression: Increase your distance or intensity by no much more than 10% per week to avoid injury.",
            "Vary your routes: Running on different terrains can strengthen various muscle groups and keep things interesting.",
            "Invest in good shoes: Proper running shoes are crucial for comfort and preventing injuries. Replace them every 500-800 km."
        ];


        // --- Utility: Local Storage ---
        function saveAppState() {
            localStorage.setItem('hydrunAppState', JSON.stringify(appState.user));
        }

        function loadAppState() {
            const storedState = localStorage.getItem('hydrunAppState');
            if (storedState) {
                const loadedUser = JSON.parse(storedState);
                appState.user.username = loadedUser.username || "";
                appState.user.email = loadedUser.email || "";
                appState.user.waterDrankDaily = parseFloat(loadedUser.waterDrankDaily) || 0;
                appState.user.waterDailyGoal = parseFloat(loadedUser.waterDailyGoal) || 2;
                appState.user.waterDrankMonthly = parseFloat(loadedUser.waterDrankMonthly) || 0;
                appState.user.waterMonthlyGoal = parseFloat(loadedUser.waterMonthlyGoal) || 60;
                appState.user.runDistanceDaily = parseFloat(loadedUser.runDistanceDaily) || 0;
                appState.user.runDailyGoal = parseFloat(loadedUser.runDailyGoal) || 5;
                appState.user.runDistanceMonthly = parseFloat(loadedUser.runDistanceMonthly) || 0;
                appState.user.runMonthlyGoal = parseFloat(loadedUser.runMonthlyGoal) || 100;
                appState.user.totalRunDistance = parseFloat(loadedUser.totalRunDistance) || 0;
                appState.user.friends = loadedUser.friends || [];
                appState.user.isPremium = loadedUser.isPremium || false;
                appState.user.lastDailyReset = loadedUser.lastDailyReset || new Date().toDateString();
                appState.user.lastMonthlyReset = loadedUser.lastMonthlyReset || new Date(new Date().getFullYear(), new Date().getMonth(), 1).toDateString();
                // Load new reminder settings
                appState.user.waterRemindersEnabled = loadedUser.waterRemindersEnabled || false;
                appState.user.runRemindersEnabled = loadedUser.runRemindersEnabled || false;
                appState.user.lastWaterReminderSent = loadedUser.lastWaterReminderSent;
                appState.user.lastRunReminderSent = loadedUser.lastRunReminderSent;
            }
            checkAndResetGoals();
        }

        function checkAndResetGoals() {
            const today = new Date().toDateString();
            const thisMonthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toDateString();

            // Daily reset
            if (appState.user.lastDailyReset !== today) {
                console.log("Resetting daily goals...");
                appState.user.waterDrankDaily = 0;
                appState.user.runDistanceDaily = 0;
                appState.user.lastDailyReset = today;
                saveAppState();
            }

            // Monthly reset
            if (appState.user.lastMonthlyReset !== thisMonthStart) {
                console.log("Resetting monthly goals...");
                appState.user.waterDrankMonthly = 0;
                appState.user.runDistanceMonthly = 0;
                appState.user.lastMonthlyReset = thisMonthStart;
                saveAppState();
            }
        }

        // --- UI Feedback Helper ---
        function showFeedback(elementId, message, type = 'success', duration = 3000) {
            const feedbackElement = document.getElementById(elementId);
            feedbackElement.textContent = message;
            feedbackElement.className = `feedback-message show ${type}`;
            feedbackElement.classList.remove('hidden');
            setTimeout(() => {
                feedbackElement.classList.add('hidden');
                feedbackElement.classList.remove('show');
            }, duration);
        }

        // --- Function to get random tips and update the display ---
        function updateTips(sectionId) {
            let tipsArray;
            let targetListId;

            if (sectionId === 'waterSection') {
                tipsArray = waterTips;
                targetListId = 'waterAdviceList';
            } else if (sectionId === 'runSection') {
                tipsArray = runTips;
                targetListId = 'runAdviceList';
            } else {
                return; // Do nothing if unknown section
            }

            const tipList = document.getElementById(targetListId);
