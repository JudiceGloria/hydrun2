<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydrun</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* --- CSS STYLES START --- */
        body {
            font-family: "Segoe UI", sans-serif;
            background: #f2f2f2;
            margin: 0;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #0077ff;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        h2 {
            color: #333;
            font-size: 1.8em;
            margin-top: 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        h3 {
            color: #555;
            font-size: 1.4em;
            margin-top: 25px;
            margin-bottom: 10px;
        }

        h4 {
            color: #666;
            font-size: 1.2em;
            margin-top: 20px;
            margin-bottom: 10px;
        }


        .card {
            background: white;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid #e0e0e0;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"],
        input[type="number"] {
            width: calc(100% - 22px); /* Account for padding and border */
            padding: 11px;
            margin: 8px 0 15px 0;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            border-color: #0077ff;
            outline: none;
        }

        button {
            padding: 12px 20px;
            background: #0077ff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
            width: 100%; /* Full width for consistency */
            margin-top: 10px; /* Space above buttons */
        }

        button:hover {
            background: #0055cc;
        }

        button:active {
            background: #0044bb;
        }

        #map {
            width: 100%;
            height: 350px;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .hidden {
            display: none;
        }

        p {
            margin-top: 15px;
            font-size: 1.1em;
            color: #444;
        }

        ul, ol {
            list-style-type: none; /* Remove default list bullets */
            padding: 0;
            margin: 15px 0;
        }

        ul li, ol li {
            background: #f9f9f9;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 6px;
            border: 1px solid #eee;
            display: flex;
            justify-content: space-between; /* Space out content if needed */
            align-items: center;
        }

        ol li {
            counter-increment: leaderboard-counter;
            padding-left: 40px; /* Space for counter */
            position: relative;
        }

        ol li::before {
            content: counter(leaderboard-counter) ".";
            position: absolute;
            left: 15px;
            font-weight: bold;
            color: #0077ff;
        }

        .highlight-user {
            background: #e6f2ff; /* Light blue background for current user */
            border-color: #0077ff;
            font-weight: bold;
        }

        #userDisplay button {
            display: inline-block;
            width: auto;
            margin-left: 15px;
            padding: 8px 15px;
            background: #dc3545; /* Red for logout */
        }

        #userDisplay button:hover {
            background: #c82333;
        }

        /* Message for user feedback */
        .feedback-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .feedback-message.show {
            opacity: 1;
        }
        .feedback-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        /* Camera specific styles */
        #cameraStream {
            width: 100%;
            height: auto;
            background-color: #000;
            border-radius: 8px;
            display: block; /* Ensure it takes full width */
            margin-bottom: 15px;
        }
        #captureCanvas {
            display: block; /* Hidden by default, shown after capture */
            margin-top: 15px;
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .camera-controls button {
            margin-top: 10px;
        }

        /* New styles for section toggling */
        .tab-buttons {
            display: flex;
            justify-content: center;
            gap: 10px; /* Space between buttons */
            margin-bottom: 25px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        .tab-buttons button {
            flex: 1; /* Make buttons take equal width */
            margin-top: 0; /* Override default button margin */
        }
        .tab-buttons button.active {
            background: #0055cc; /* Darker blue for active tab */
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); /* Inset shadow for active state */
        }

        /* Styles for AI Advice sections */
        .ai-advice {
            background-color: #e8f5e9; /* Light green background */
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            color: #2e7d32; /* Dark green text */
        }
        .ai-advice h4 {
            color: #1b5e20; /* Even darker green for heading */
            margin-top: 0;
            margin-bottom: 10px;
        }
        .ai-advice ul {
            list-style-type: disc; /* Use regular bullets for lists */
            margin-left: 20px;
            padding-left: 0;
        }
        .ai-advice ul li {
            background: none;
            border: none;
            padding: 5px 0;
            margin-bottom: 5px;
            color: #388e3c;
        }

        /* --- CSS STYLES END --- */
    </style>
</head>
<body>
    <div id="loginContainer" class="card">
        <h2>Login to Hydrun</h2>
        <input type="text" id="username" placeholder="Enter your name" />
        <button onclick="login()">Login</button>
    </div>

    <div id="appContainer" class="hidden">
        <header>
            <h1>üèÉüíß Hydrun</h1>
            <p>Welcome, <span id="userDisplay"></span> <button onclick="logout()">Logout</button></p>
        </header>

        <div class="tab-buttons">
            <button id="showWaterBtn" onclick="showSection('waterSection')">üíß Water Tracker</button>
            <button id="showRunBtn" onclick="showSection('runSection')">üèÉ Run Tracker</button>
        </div>

        <section id="waterSection" class="card">
            <h2>üíß Water Tracker</h2>
            <label>Daily Goal (L): <input type="number" id="waterDailyGoal" value="2" min="0.1" step="0.1" /></label>
            <label>Monthly Goal (L): <input type="number" id="waterMonthlyGoal" value="60" min="1" step="1" /></label>
            <label>Add Water (L): <input type="number" id="waterInput" min="0.1" step="0.1" /></label>
            <button onclick="logWater()">Add Water</button>
            <p>Daily: <span id="waterDailyStatus">Drank: 0.00 L (0.0%)</span></p>
            <p>Monthly: <span id="waterMonthlyStatus">Drank: 0.00 L (0.0%)</span></p>
            <div id="waterFeedback" class="feedback-message hidden"></div>

            <hr> <h3>üì∏ Camera for Water Estimation</h3>
            <p>Use your camera to capture an image of your water container. Based on the picture, **you'll need to manually estimate** the water added or remaining and log it above.</p>
            <button onclick="startCamera()">Start Camera</button>
            <button onclick="captureImage()">Capture Image</button>
            <button onclick="stopCamera()">Stop Camera</button>
            <video id="cameraStream" autoplay playsinline class="hidden"></video>
            <canvas id="captureCanvas" class="hidden"></canvas>
            <div id="cameraFeedback" class="feedback-message hidden"></div>

            <hr> <div class="ai-advice">
                <h4>üß† AI Water Advice</h4>
                <ul>
                    <li>**Stay consistent:** Sip water throughout the day, don't wait until you're thirsty!</li>
                    <li>**Hydrate before meals:** Drinking a glass of water before eating can aid digestion and help manage appetite.</li>
                    <li>**Factor in activity:** Increase your water intake when exercising or in hot weather. Aim for 0.5-1.0L per hour of moderate to intense activity.</li>
                    <li>**Monitor urine color:** Pale yellow usually indicates good hydration. Darker urine suggests you need more water.</li>
                    <li>**Add flavor naturally:** If plain water is boring, try adding slices of lemon, cucumber, or berries.</li>
                </ul>
            </div>
        </section>

        <section id="runSection" class="card hidden">
            <h2>üìç Run Tracker</h2>
            <label>Daily Goal (km): <input type="number" id="runDailyGoal" value="5" min="0.1" step="0.1" /></label>
            <label>Monthly Goal (L): <input type="number" id="runMonthlyGoal" value="100" min="1" step="1" /></label>
            <button onclick="startRun()">Start Run</button>
            <button onclick="stopRun()">Stop Run</button>
            <p id="runStatus">Not running</p>
            <p id="distanceDisplay">Current Run: 0.00 km</p>
            <p>Daily: <span id="runDailyStatus">Ran: 0.00 km (0.0%)</span></p>
            <p>Monthly: <span id="runMonthlyStatus">Ran: 0.00 km (0.0%)</span></p>
            <p>Total Lifetime Run: <span id="totalRunDisplay">0.00 km</span></p>
            <div id="map"></div> <div id="runFeedback" class="feedback-message hidden"></div>

            <hr> <div class="ai-advice">
                <h4>üß† AI Running Advice</h4>
                <ul>
                    <li>**Pre-run hydration:** Drink 500ml of water 1-2 hours before your run.</li>
                    <li>**During long runs:** For runs over 60 minutes, consider electrolytes or sports drinks. Aim for 150-250ml every 15-20 minutes.</li>
                    <li>**Post-run recovery:** Replenish fluids and electrolytes immediately after your run. Weigh yourself before and after a run to estimate fluid loss (1kg lost = 1 liter to replace).</li>
                    <li>**Warm-up is key:** Always start with a dynamic warm-up to prepare your muscles and prevent injury.</li>
                    <li>**Listen to your body:** Don't push through sharp pain. Rest and recovery are just as important as training.</li>
                </ul>
            </div>

            <hr> <h3>üë´ Friends & Leaderboard</h3>
            <label>Add friend by username: <input type="text" id="friendName" placeholder="Friend's username" /></label>
            <button onclick="addFriend()">Add Friend</button>
            <div id="friendFeedback" class="feedback-message hidden"></div>

            <h4>Your Friends</h4>
            <ul id="friendList"></ul>

            <h4>üèÜ Leaderboard</h4>
            <ol id="leaderboardList"></ol>
        </section>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        /* --- JAVASCRIPT LOGIC START --- */
        // --- Centralized App State ---
        let appState = {
            user: {
                username: "",
                waterDrankDaily: 0,
                waterDailyGoal: 2,
                waterDrankMonthly: 0, 
                waterMonthlyGoal: 60, 
                runDistanceDaily: 0, 
                runDailyGoal: 5, 
                runDistanceMonthly: 0, 
                runMonthlyGoal: 100, 
                totalRunDistance: 0, 
                friends: [],
                lastDailyReset: new Date().toDateString(), 
                lastMonthlyReset: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toDateString() 
            },
            currentRun: {
                isActive: false,
                segmentDistance: 0, 
                routeCoordinates: [], 
                watchId: null, 
                map: null,      // Will now hold Leaflet map object
                marker: null,   // Will now hold Leaflet marker object
                polyline: null // To draw the path
            },
            otherRunners: [
                { name: "Alice", totalRunDistance: 7.2 },
                { name: "Bob", totalRunDistance: 5.5 },
                { name: "Charlie", totalRunDistance: 6.8 },
                { name: "Diana", totalRunDistance: 8.1 },
                { name: "Eve", totalRunDistance: 12.3 },
                { name: "Frank", totalRunDistance: 4.0 }
            ],
            cameraStream: null 
        };

        // --- Utility: Local Storage ---
        function saveAppState() {
            localStorage.setItem('hydrunAppState', JSON.stringify(appState.user));
        }

        function loadAppState() {
            const storedState = localStorage.getItem('hydrunAppState');
            if (storedState) {
                const loadedUser = JSON.parse(storedState);
                appState.user.username = loadedUser.username || "";
                appState.user.waterDrankDaily = parseFloat(loadedUser.waterDrankDaily) || 0;
                appState.user.waterDailyGoal = parseFloat(loadedUser.waterDailyGoal) || 2;
                appState.user.waterDrankMonthly = parseFloat(loadedUser.waterDrankMonthly) || 0;
                appState.user.waterMonthlyGoal = parseFloat(loadedUser.waterMonthlyGoal) || 60;
                appState.user.runDistanceDaily = parseFloat(loadedUser.runDistanceDaily) || 0;
                appState.user.runDailyGoal = parseFloat(loadedUser.runDailyGoal) || 5;
                appState.user.runDistanceMonthly = parseFloat(loadedUser.runDistanceMonthly) || 0;
                appState.user.runMonthlyGoal = parseFloat(loadedUser.runMonthlyGoal) || 100;
                appState.user.totalRunDistance = parseFloat(loadedUser.totalRunDistance) || 0;
                appState.user.friends = loadedUser.friends || [];
                appState.user.lastDailyReset = loadedUser.lastDailyReset || new Date().toDateString();
                appState.user.lastMonthlyReset = loadedUser.lastMonthlyReset || new Date(new Date().getFullYear(), new Date().getMonth(), 1).toDateString();
            }
            checkAndResetGoals(); 
        }

        function checkAndResetGoals() {
            const today = new Date().toDateString();
            const thisMonthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toDateString();

            //
