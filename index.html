make this into a downlowd <!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Hydrun</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background: #f2f2f2;
            margin: 0;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #0077ff;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        h2 {
            color: #333;
            font-size: 1.8em;
            margin-top: 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        h3 {
            color: #555;
            font-size: 1.4em;
            margin-top: 25px;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid #e0e0e0;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"],
        input[type="number"] {
            width: calc(100% - 22px); /* Account for padding and border */
            padding: 11px;
            margin: 8px 0 15px 0;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            border-color: #0077ff;
            outline: none;
        }

        button {
            padding: 12px 20px;
            background: #0077ff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
            width: 100%; /* Full width for consistency */
            margin-top: 10px; /* Space above buttons */
        }

        button:hover {
            background: #0055cc;
        }

        button:active {
            background: #0044bb;
        }

        #map {
            width: 100%;
            height: 350px;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .hidden {
            display: none;
        }

        p {
            margin-top: 15px;
            font-size: 1.1em;
            color: #444;
        }

        ul, ol {
            list-style-type: none; /* Remove default list bullets */
            padding: 0;
            margin: 15px 0;
        }

        ul li, ol li {
            background: #f9f9f9;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 6px;
            border: 1px solid #eee;
            display: flex;
            justify-content: space-between; /* Space out content if needed */
            align-items: center;
        }

        ol li {
            counter-increment: leaderboard-counter;
            padding-left: 40px; /* Space for counter */
            position: relative;
        }

        ol li::before {
            content: counter(leaderboard-counter) ".";
            position: absolute;
            left: 15px;
            font-weight: bold;
            color: #0077ff;
        }

        .highlight-user {
            background: #e6f2ff; /* Light blue background for current user */
            border-color: #0077ff;
            font-weight: bold;
        }

        #userDisplay button {
            display: inline-block;
            width: auto;
            margin-left: 15px;
            padding: 8px 15px;
            background: #dc3545; /* Red for logout */
        }

        #userDisplay button:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div id="loginContainer" class="card">
        <h2>Login to Hydrun</h2>
        <input type="text" id="username" placeholder="Enter your name" />
        <button onclick="login()">Login</button>
    </div>

    <div id="appContainer" class="hidden">
        <header>
            <h1>üèÉüíß Hydrun</h1>
            <p>Welcome, <span id="userDisplay"></span> <button onclick="logout()">Logout</button></p>
        </header>

        <section class="card">
            <h2>üíß Water Tracker</h2>
            <label>Daily Goal (L): <input type="number" id="waterGoal" value="2" min="0.1" step="0.1" /></label>
            <label>Add Water (L): <input type="number" id="waterInput" min="0.1" step="0.1" /></label>
            <button onclick="logWater()">Add Water</button>
            <p id="waterStatus">Drank: 0.00 L (0.0%)</p>
        </section>

        <section class="card">
            <h2>üìç Live Run Tracker</h2>
            <button onclick="startRun()">Start Run</button>
            <button onclick="stopRun()">Stop Run</button>
            <p id="runStatus">Not running</p>
            <p id="distanceDisplay">Current Run: 0.00 km</p>
            <p>Total Lifetime Run: <span id="totalRunDisplay">0.00 km</span></p>
            <div id="map"></div>
        </section>

        <section class="card">
            <h2>üë´ Friends & Leaderboard</h2>
            <label>Add friend by username: <input type="text" id="friendName" placeholder="Friend's username" /></label>
            <button onclick="addFriend()">Add Friend</button>

            <h3>Your Friends</h3>
            <ul id="friendList"></ul>

            <h3>üèÜ Leaderboard</h3>
            <ol id="leaderboardList"></ol>
        </section>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script>
        // --- Centralized App State ---
        let appState = {
            user: {
                username: "",
                waterDrank: 0,
                waterGoal: 2,
                totalRunDistance: 0, // Accumulates all runs
                friends: []
            },
            currentRun: {
                isActive: false,
                segmentDistance: 0, // Distance for the currently active run
                routeCoordinates: [],
                watchId: null, // GPS watch ID
                map: null,
                marker: null,
            },
            // Simulated other runners for the leaderboard (in a real app, this would be from a backend)
            otherRunners: [
                { name: "Alice", totalRunDistance: 7.2 },
                { name: "Bob", totalRunDistance: 5.5 },
                { name: "Charlie", totalRunDistance: 6.8 },
                { name: "Diana", totalRunDistance: 8.1 },
                { name: "Eve", totalRunDistance: 12.3 },
                { name: "Frank", totalRunDistance: 4.0 }
            ]
        };

        // --- Utility: Local Storage ---
        function saveAppState() {
            localStorage.setItem('hydrunAppState', JSON.stringify(appState.user));
        }

        function loadAppState() {
            const storedState = localStorage.getItem('hydrunAppState');
            if (storedState) {
                const loadedUser = JSON.parse(storedState);
                // Assign loaded values, ensuring numbers are parsed correctly
                appState.user.username = loadedUser.username || "";
                appState.user.waterDrank = parseFloat(loadedUser.waterDrank) || 0;
                appState.user.waterGoal = parseFloat(loadedUser.waterGoal) || 2;
                appState.user.totalRunDistance = parseFloat(loadedUser.totalRunDistance) || 0;
                appState.user.friends = loadedUser.friends || [];
            }
        }

        // --- Core UI Management ---
        function updateAppUI() {
            if (appState.user.username) {
                document.getElementById("loginContainer").classList.add("hidden");
                document.getElementById("appContainer").classList.remove("hidden");
                document.getElementById("userDisplay").textContent = appState.user.username;
                document.getElementById("waterGoal").value = appState.user.waterGoal;

                // Initial updates
                updateWaterProgress();
                updateTotalRunDisplay();
                updateFriendList();
                updateLeaderboard();
            } else {
                document.getElementById("loginContainer").classList.remove("hidden");
                document.getElementById("appContainer").classList.add("hidden");
            }
        }

        // --- Login/Logout ---
        function login() {
            const usernameInput = document.getElementById("username");
            const username = usernameInput.value.trim();
            if (!username) {
                alert("Please enter a username.");
                return;
            }
            appState.user.username = username;
            saveAppState();
            updateAppUI();
        }

        function logout() {
            localStorage.removeItem('hydrunAppState'); // Clear all stored data
            location.reload(); // Reload the page to reset the app state and show login
        }

        // --- Water Tracking ---
        function logWater() {
            const waterInput = document.getElementById("waterInput");
            const amount = parseFloat(waterInput.value);
            if (!isNaN(amount) && amount > 0) {
                appState.user.waterDrank += amount;
                waterInput.value = ''; // Clear input field
                saveAppState();
                updateWaterProgress();
            } else {
                alert("Please enter a valid positive number for water.");
            }
        }

        function updateWaterProgress() {
            const goalInput = document.getElementById("waterGoal");
            const goal = parseFloat(goalInput.value);
            appState.user.waterGoal = goal; // Update goal in state
            const percent = ((appState.user.waterDrank / goal) * 100).toFixed(1);
            document.getElementById("waterStatus").textContent =
                `Drank: ${appState.user.waterDrank.toFixed(2)} L (${percent}%)`;
            saveAppState(); // Save state after progress update (including goal change)
        }

        // Listen for changes on the water goal input
        document.getElementById("waterGoal").addEventListener('change', updateWaterProgress);

        // --- Run Tracking (Mapbox Integration) ---
        mapboxgl.accessToken = 'YOUR_MAPBOX_ACCESS_TOKEN'; // <<< IMPORTANT: Replace with your Mapbox Public Access Token!

        function initMap() {
            if (appState.currentRun.map) return; // Map already initialized

            appState.currentRun.map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [0, 0], // Will be updated to user's location
                zoom: 15
            });

            appState.currentRun.map.on('load', () => {
                appState.currentRun.map.addSource('route', {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        geometry: { type: 'LineString', coordinates: [] }
                    }
                });
                appState.currentRun.map.addLayer({
                    id: 'routeLine',
                    type: 'line',
                    source: 'route',
                    paint: {
                        'line-color': '#0077ff',
                        'line-width': 4
                    }
                });
            });
        }

        function startRun() {
            if (appState.currentRun.isActive) {
                alert("A run is already in progress!");
                return;
            }

            if (!navigator.geolocation) {
                alert("GPS not supported by your browser.");
                return;
            }

            initMap(); // Ensure map is initialized

            appState.currentRun.isActive = true;
            appState.currentRun.segmentDistance = 0; // Reset distance for this new run
            appState.currentRun.routeCoordinates = []; // Clear previous route
            document.getElementById('runStatus').textContent = 'Running...';
            document.getElementById('distanceDisplay').textContent = `Current Run: 0.00 km`;

            // Get initial position and set map center/marker
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                const coords = [longitude, latitude];
                appState.currentRun.map.setCenter(coords);

                if (appState.currentRun.marker) {
                    appState.currentRun.marker.setLngLat(coords);
                } else {
                    appState.currentRun.marker = new mapboxgl.Marker().setLngLat(coords).addTo(appState.currentRun.map);
                }
                appState.currentRun.routeCoordinates.push(coords);
                drawRoute();
            }, err => console.error("Error getting initial location:", err), { enableHighAccuracy: true });


            appState.currentRun.watchId = navigator.geolocation.watchPosition(pos => {
                const { latitude, longitude } = pos.coords;
                const newCoords = [longitude, latitude];

                if (appState.currentRun.routeCoordinates.length > 0) {
                    const lastCoords = appState.currentRun.routeCoordinates[appState.currentRun.routeCoordinates.length - 1];
                    const segmentD = getDistanceFromLatLon(lastCoords[1], lastCoords[0], newCoords[1], newCoords[0]);
                    appState.currentRun.segmentDistance += segmentD;
                }

                appState.currentRun.routeCoordinates.push(newCoords);
                appState.currentRun.marker.setLngLat(newCoords);
                appState.currentRun.map.setCenter(newCoords); // Keep map centered on user
                drawRoute();
                document.getElementById('distanceDisplay').textContent = `Current Run: ${appState.currentRun.segmentDistance.toFixed(2)} km`;

            }, err => console.error("Error watching position:", err), { enableHighAccuracy: true });
        }

        function stopRun() {
            if (!appState.currentRun.isActive) {
                alert("No run is currently in progress.");
                return;
            }

            if (appState.currentRun.watchId !== null) {
                navigator.geolocation.clearWatch(appState.currentRun.watchId);
                appState.currentRun.watchId = null;
            }

            appState.currentRun.isActive = false;
            document.getElementById('runStatus').textContent = 'Not running';
            alert(`Run stopped. Distance: ${appState.currentRun.segmentDistance.toFixed(2)} km`);

            // Add this run's distance to the user's total lifetime distance
            appState.user.totalRunDistance += appState.currentRun.segmentDistance;
            saveAppState(); // Save the updated total run distance
            updateTotalRunDisplay(); // Update lifetime display
            updateLeaderboard(); // Refresh leaderboard

            // Reset for the next run
            appState.currentRun.segmentDistance = 0;
            appState.currentRun.routeCoordinates = [];
            // Optionally remove the route line or reset map view
            if (appState.currentRun.map && appState.currentRun.map.getSource('route')) {
                appState.currentRun.map.getSource('route').setData({
                    type: 'Feature',
                    geometry: { type: 'LineString', coordinates: [] }
                });
            }
        }

        function drawRoute() {
            if (appState.currentRun.map && appState.currentRun.map.getSource('route')) {
                appState.currentRun.map.getSource('route').setData({
                    type: 'Feature',
                    geometry: { type: 'LineString', coordinates: appState.currentRun.routeCoordinates }
                });
            }
        }

        function updateTotalRunDisplay() {
            document.getElementById('totalRunDisplay').textContent = `${appState.user.totalRunDistance.toFixed(2)} km`;
        }

        // Haversine formula to calculate distance between two lat/lon points
        function getDistanceFromLatLon(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // --- Friends & Leaderboard ---
        function addFriend() {
            const friendNameInput = document.getElementById("friendName");
            const friendName = friendNameInput.value.trim();

            if (!friendName) return;

            // Prevent adding self or duplicates
            if (friendName === appState.user.username || appState.user.friends.includes(friendName)) {
                alert(`Cannot add "${friendName}". Either it's you or they're already on your list.`);
                return;
            }

            appState.user.friends.push(friendName);
            saveAppState(); // Save updated friends list
            updateFriendList();
            friendNameInput.value = ''; // Clear input
            updateLeaderboard(); // Update leaderboard with new friend (if they are in otherRunners)
        }

        function updateFriendList() {
            const list = document.getElementById("friendList");
            list.innerHTML = '';
            appState.user.friends.forEach(f => {
                const li = document.createElement('li');
                li.textContent = f;
                list.appendChild(li);
            });
        }

        function updateLeaderboard() {
            // Combine current user with other runners
            let allRunners = [
                { name: appState.user.username, totalRunDistance: appState.user.totalRunDistance }
            ];

            // Add other simulated runners, but only if they are not the current user's friends
            appState.otherRunners.forEach(other => {
                if (!appState.user.friends.includes(other.name) && other.name !== appState.user.username) {
                    allRunners.push(other);
                }
            });

            // Add friends from the user's friends list (if their data exists in otherRunners)
            appState.user.friends.forEach(friendName => {
                const friendData = appState.otherRunners.find(r => r.name === friendName);
                if (friendData) {
                    allRunners.push(friendData);
                }
            });


            // Sort by totalRunDistance in descending order
            allRunners.sort((a, b) => b.totalRunDistance - a.totalRunDistance);

            const leaderboard = document.getElementById("leaderboardList");
            leaderboard.innerHTML = ''; // Clear existing list

            // Populate the leaderboard
            allRunners.forEach(runner => {
                const li = document.createElement('li');
                li.textContent = `${runner.name} - ${runner.totalRunDistance.toFixed(2)} km`;
                if (runner.name === appState.user.username) {
                    li.classList.add('highlight-user'); // Highlight current user
                }
                leaderboard.appendChild(li);
            });
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadAppState(); // Load data when the DOM is ready
            updateAppUI();  // Update UI based on loaded data
            initMap();      // Initialize the map (but don't start running yet)
        });
    </script>
</body>
</html>
